<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
      (function() {
        const saved = localStorage.getItem('totemino_theme');
        const theme = saved || 
          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
    <title>Pagamento - Totemino</title>
    <link rel="icon" type="image/png" href="img/favicon.png">
    <link rel="stylesheet" href="payment-success-styles.css"/>
</head>
<body>
    <div class="success-container">
        <div class="success-icon" id="status-icon">
            <div class="checkmark"></div>
        </div>
        
        <h1 id="status-title">Pagamento Completato!</h1>
        <p class="message" id="status-message">Grazie per aver scelto il nostro servizio.</p>
        
        <div id="loading-section" class="loading">
            <div class="spinner"></div>
            <p>Verifica del pagamento in corso...</p>
        </div>

        <div id="plan-section" class="plan-info" style="display: none;">
            <div class="plan-name" id="plan-name"></div>
            <div class="plan-details">Il tuo account è stato aggiornato con successo</div>
        </div>

        <div id="error-section" class="error-container" style="display: none;">
            <div class="error-title">Dettagli Errore</div>
            <div class="error-message" id="error-message"></div>
        </div>

        <div class="btn-container">
            <a href="/profile.html" class="btn" id="dashboard-btn">Vai alla Dashboard</a>
        </div>
    </div>

    <script>
        async function verifyPayment() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');

            if (!sessionId) {
                showError('Session ID mancante nell\'URL');
                return;
            }

            try {
                const response = await fetch(`/api/verify-payment/${sessionId}`, {
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Errore nella verifica del pagamento');
                }

                if (data.paid) {
                    showSuccess(data.planType);
                } else {
                    showError(`Pagamento non completato. Stato: ${data.paymentStatus}`);
                }

            } catch (error) {
                console.error('Errore verifica:', error);
                showError(error.message || 'Errore sconosciuto durante la verifica');
            }
        }

        function showSuccess(planType) {
            document.getElementById('loading-section').style.display = 'none';
            
            const planSection = document.getElementById('plan-section');
            const planName = document.getElementById('plan-name');
            
            // ✅ Gestisci tutti i casi possibili
            const planNames = {
                'hobby': 'Piano Hobby',
                'premium': 'Piano Premium',
                'pro': 'Piano Pro'
            };
            
            planName.textContent = planNames[planType] || 'Piano Premium';
            planSection.style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loading-section').style.display = 'none';
            
            const statusIcon = document.getElementById('status-icon');
            statusIcon.innerHTML = '<div class="errormark"></div>';
            
            document.getElementById('status-title').textContent = 'Pagamento Non Riuscito';
            document.getElementById('status-message').textContent = 'Si è verificato un problema durante il processo di pagamento.';
            
            const errorSection = document.getElementById('error-section');
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.textContent = message;
            errorSection.style.display = 'block';
        }

        function showSuccess(planType) {
            document.getElementById('loading-section').style.display = 'none';
            
            const planSection = document.getElementById('plan-section');
            const planName = document.getElementById('plan-name');
            
            planName.textContent = planType === 'pro' ? 'Piano Pro' : 'Piano Premium';
            planSection.style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loading-section').style.display = 'none';
            
            // Cambia icona in X rossa
            const statusIcon = document.getElementById('status-icon');
            statusIcon.innerHTML = '<div class="errormark"></div>';
            
            // Cambia titolo e messaggio principale
            document.getElementById('status-title').textContent = 'Pagamento Non Riuscito';
            document.getElementById('status-message').textContent = 'Si è verificato un problema durante il processo di pagamento.';
            
            // Mostra dettagli errore
            const errorSection = document.getElementById('error-section');
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.textContent = message;
            errorSection.style.display = 'block';
        }

        window.addEventListener('DOMContentLoaded', verifyPayment);
    </script>
</body>
</html>