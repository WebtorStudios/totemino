<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totemino - Il tuo ordine</title>
    <link rel="icon" type="image/png" href="img/favicon.png">
    <style>
        @import url("menu-styles.css");

        .receipt-container {
            background: var(--card-bg);
            max-width: 500px;
            width: calc(100% - 2rem);
            border: 8px solid var(--text-accent);
            margin: 1rem auto;
            transition: background-color 0.4s, border-color 0.4s;
        }

        .receipt-header {
            text-align: center;
            padding: 2rem 2rem 2rem;
            border-bottom: 3px dashed var(--text-accent);
        }

        .receipt-header h1 {
            font-family: 'CalSans', sans-serif;
            font-size: 2.5rem;
            color: var(--text-accent);
            margin: 0 0 0.5rem 0;
        }

        .receipt-body { 
            padding: 2rem;
            text-align: left;
        }

        .order-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .order-item:last-child {
            margin-bottom: 0rem;
        }

        .order-item img {
            width: 70px;
            height: 70px;
            object-fit: contain;
        }

        .item-text {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex: 1;
        }

        .item-name {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .item-custom {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 0.25rem;
        }

        .empty-order {
            text-align: center;
            padding: 3rem 2rem;
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        @media (max-width: 600px) {
            .receipt-container { border-width: 5px; }
            .receipt-header h1 { font-size: 2rem; }
            .receipt-body { padding: 1.5rem; }
            .order-item img { width: 60px; height: 60px; }
            .item-name { font-size: 1rem; }
            .item-custom { font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div class="bg-light light1"></div>
    <div class="bg-light light2"></div>
    <div class="bg-light light3"></div>

    <div class="title">
        <div class="logo_space">
            <img class="theme-img" data-light="img/logo_light.png" data-dark="img/logo_dark.png" alt="Logo">
            <a href="index.html"><h1>Totemino</h1></a>
        </div>
        <div>
            <button id="back-to-checkout" class="header-btn" type="button">
                <img class="theme-img" data-light="img/exit_light.png" data-dark="img/exit_dark.png" alt="Torna">
            </button>
            <button id="theme" class="header-btn" type="button">
                <img class="theme-img" data-light="img/theme_light.png" data-dark="img/theme_dark.png" alt="Tema">
            </button>
        </div>
    </div>

    <div class="receipt-container">
        <div class="receipt-header">
            <h1>Il tuo ordine</h1>
            <p>Detta l'ordine al personale per confermarlo</p>
        </div>
        <div class="receipt-body">
            <div id="orderContent">Caricamento...</div>
        </div>
    </div>
    
    <script src="theme.js"></script>
    <script>
        const id = new URLSearchParams(window.location.search).get('id');
        const content = document.getElementById('orderContent');
        
        document.getElementById('back-to-checkout').onclick = () => {
            window.location.href = `checkout.html?id=${id}`;
        };

        if (!id) {
            content.innerHTML = '<div class="empty-order">ID mancante</div>';
        } else {
            (async () => {
                try {
                    const [menu, custom] = await Promise.all([
                        fetch(`IDs/${id}/menu.json`).then(r => r.json()),
                        fetch(`IDs/${id}/customization.json`).then(r => r.json()).catch(() => ({}))
                    ]);

                    const order = JSON.parse(localStorage.getItem('totemino_selected') || '[]');
                    
                    if (!order.length) {
                        content.innerHTML = '<div class="empty-order">Ordine vuoto</div>';
                        return;
                    }

                    let html = '';
                    
                    for (let i = 0; i < order.length; i += 3) {
                        const name = order[i].split('|')[0];
                        const qty = parseInt(order[i + 1]);
                        const customObj = JSON.parse(order[i + 2] || '{}');
                        
                        const item = menu.categories.flatMap(c => c.items).find(it => it.name === name);
                        if (!item) continue;

                        const customNames = [];
                        if (item.customizationGroup && custom[item.customizationGroup]) {
                            for (const section of custom[item.customizationGroup]) {
                                for (const opt of section.options) {
                                    if (customObj[opt.id] === 1) customNames.push(opt.name);
                                }
                            }
                        }

                        const img = item.imagePath.startsWith('IDs/') ? item.imagePath : `IDs/${id}/${item.imagePath}`;
                        
                        html += `<div class="order-item">
                            <img src="${img}" alt="${name}" onerror="this.style.display='none'">
                            <div class="item-text">
                                <div class="item-name">${name}${qty > 1 ? ` (x${qty})` : ''}</div>
                                ${customNames.length ? `<div class="item-custom">(${customNames.join(', ')})</div>` : ''}
                            </div>
                        </div>`;
                    }

                    content.innerHTML = html || '<div class="empty-order">Nessun articolo</div>';

                } catch (err) {
                    content.innerHTML = '<div class="empty-order">Errore caricamento</div>';
                }
            })();
        }
    </script>
</body>
</html>